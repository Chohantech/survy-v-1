############################################################ 
# üåê Makefile ‚Äî Nginx + Next.js Deployment (Independent Commands)
# ---------------------------------------------------------
# Author: Zahid Khan (Updated by Muhammad Majid / ChatGPT)
# Version: 3.3
############################################################

# ==========================================================
# üîß VARIABLES
# ==========================================================
DOMAIN             := svryn.com
APP_DIR            := /var/www/$(DOMAIN)/frontend
NGINX_DIR          := /var/www/$(DOMAIN)/nginx
NGINX_SITE_DIR     := /etc/nginx/sites-available
NGINX_ENABLED_DIR  := /etc/nginx/sites-enabled
CONFIG_FILE        := $(NGINX_SITE_DIR)/$(DOMAIN)
LOCAL_CONF_PATH    := $(NGINX_DIR)/$(DOMAIN).conf
DEFAULT_CONF       := /etc/nginx/sites-available/default
HEADERS_CONF_LOCAL := $(NGINX_DIR)/headers.conf
HEADERS_CONF_DEST  := /etc/nginx/conf.d/headers.conf
DEFAULT_NGINX_DIR  := $(NGINX_DIR)/nginx.conf
DEFAULT_NGINX      := /etc/nginx/nginx.conf

GREEN   := \033[1;32m
RED     := \033[1;31m
YELLOW  := \033[1;33m
CYAN    := \033[1;36m
RESET   := \033[0m

# ==========================================================
# üß≠ HELP MENU
# ==========================================================
help:
	@echo ""
	@echo "$(CYAN)üåç Nginx + Next.js Deployment Helper$(RESET)"
	@echo "==============================================================="
	@echo "$(YELLOW)Usage:$(RESET) make <target>"
	@echo ""
	@echo "$(YELLOW)Available Commands:$(RESET)"
	@echo "  $(GREEN)deploy-all        $(RESET)‚Üí Full automated setup pipeline"
	@echo "  $(GREEN)install           $(RESET)‚Üí Install and enable Nginx"
	@echo "  $(GREEN)setup-dir         $(RESET)‚Üí Create app directories"
	@echo "  $(GREEN)copy-config       $(RESET)‚Üí Copy Nginx config + headers"
	@echo "  $(GREEN)test              $(RESET)‚Üí Validate Nginx syntax"
	@echo "  $(GREEN)start             $(RESET)‚Üí Start Nginx service"
	@echo "  $(GREEN)stop              $(RESET)‚Üí Stop Nginx service"
	@echo "  $(GREEN)restart           $(RESET)‚Üí Restart Nginx service"
	@echo "  $(GREEN)reload            $(RESET)‚Üí Reload Nginx configuration"
	@echo "  $(GREEN)restart-clean     $(RESET)‚Üí Stop ‚Üí Free Ports ‚Üí Start"
	@echo "  $(GREEN)free-ports        $(RESET)‚Üí Release ports 80/443"
	@echo "  $(GREEN)enable-ssl        $(RESET)‚Üí Configure SSL with Certbot"
	@echo "  $(GREEN)test-site         $(RESET)‚Üí Check HTTP & HTTPS responses"
	@echo "  $(GREEN)rollback-config   $(RESET)‚Üí Restore default Nginx config"
	@echo "  $(GREEN)clean             $(RESET)‚Üí Remove site configuration & SSL"
	@echo "==============================================================="
	@echo "$(CYAN)üí° Tip: Run 'make deploy-all' for complete setup.$(RESET)"
	@echo ""

# ==========================================================
# üöÄ FULL DEPLOYMENT
# ==========================================================
deploy-all: install setup-dir copy-config start enable-ssl test-site
	@echo "$(GREEN)üéâ Deployment complete!$(RESET)"
	@echo "$(CYAN)‚û°Ô∏è Visit: https://$(DOMAIN)$(RESET)"

# ==========================================================
# 1Ô∏è‚É£ INSTALL & ENABLE NGINX
# ==========================================================
install:
	@echo "$(YELLOW)üì¶ Installing Nginx...$(RESET)"
	@if ! command -v nginx >/dev/null 2>&1; then \
		sudo apt update -y && sudo apt install -y nginx; \
	else \
		echo "$(GREEN)‚úÖ Nginx already installed.$(RESET)"; \
	fi
	@sudo systemctl enable nginx --now
	@sudo ufw allow 'Nginx Full' >/dev/null 2>&1 || true

# ==========================================================
# 2Ô∏è‚É£ DIRECTORY SETUP
# ==========================================================
setup-dir:
	@echo "$(YELLOW)üìÅ Creating directories...$(RESET)"
	@sudo mkdir -p /var/www/letsencrypt
	@sudo mkdir -p $(APP_DIR)
	@sudo chown -R www-data:www-data $(APP_DIR)
	@sudo chmod -R 755 $(APP_DIR)
	@echo "$(GREEN)‚úÖ Directories ready.$(RESET)"

# ==========================================================
# 3Ô∏è‚É£ COPY CONFIGS, HEADERS & MAIN NGINX
# ==========================================================
copy-config:
	@echo "$(YELLOW)‚öôÔ∏è Copying Nginx configs & headers...$(RESET)"

	# Copy main nginx.conf
	@if [ ! -f "$(DEFAULT_NGINX_DIR)" ]; then \
		echo "$(RED)‚ùå Missing main nginx.conf: $(DEFAULT_NGINX_DIR)$(RESET)"; exit 1; \
	fi
	@sudo cp $(DEFAULT_NGINX_DIR) $(DEFAULT_NGINX)

	# Copy headers.conf
	@if [ ! -f "$(HEADERS_CONF_LOCAL)" ]; then \
		echo "$(RED)‚ùå Missing headers file: $(HEADERS_CONF_LOCAL)$(RESET)"; exit 1; \
	fi
	@sudo cp $(HEADERS_CONF_LOCAL) $(HEADERS_CONF_DEST)

	# Copy site config
	@if [ ! -f "$(LOCAL_CONF_PATH)" ]; then \
		echo "$(RED)‚ùå Missing site config: $(LOCAL_CONF_PATH)$(RESET)"; exit 1; \
	fi
	@sudo cp $(LOCAL_CONF_PATH) $(CONFIG_FILE)
	@sudo ln -sf $(CONFIG_FILE) $(NGINX_ENABLED_DIR)/$(DOMAIN)

	# Test Nginx config
	@sudo nginx -t && echo "$(GREEN)‚úÖ Nginx config valid.$(RESET)" || (echo "$(RED)‚ùå Config test failed.$(RESET)" && exit 1)
	@echo "$(GREEN)‚úÖ All configs copied successfully.$(RESET)"

# ==========================================================
# 4Ô∏è‚É£ VALIDATE CONFIGURATION
# ==========================================================
test:
	@echo "$(YELLOW)üß™ Validating Nginx syntax...$(RESET)"
	@if sudo nginx -t; then \
		echo "$(GREEN)‚úÖ Syntax valid.$(RESET)"; \
	else \
		echo "$(RED)‚ùå Syntax invalid!$(RESET)"; \
		exit 1; \
	fi

# ==========================================================
# 5Ô∏è‚É£ CONTROL NGINX
# ==========================================================
start:
	@echo "$(YELLOW)‚ñ∂Ô∏è Starting Nginx...$(RESET)"
	@sudo systemctl start nginx >/dev/null 2>&1 || true
	@echo "$(GREEN)‚úÖ Nginx started.$(RESET)"

stop:
	@echo "$(YELLOW)‚èπÔ∏è Stopping Nginx...$(RESET)"
	@sudo systemctl stop nginx >/dev/null 2>&1 || true
	@sudo pkill -f nginx 2>/dev/null || true
	@sudo lsof -ti :80 -sTCP:LISTEN | xargs -r sudo kill -9 || true
	@sudo lsof -ti :443 -sTCP:LISTEN | xargs -r sudo kill -9 || true

restart: stop start

reload:
	@echo "$(YELLOW)üîÅ Reloading Nginx...$(RESET)"
	@sudo systemctl reload nginx && echo "$(GREEN)‚úÖ Reloaded.$(RESET)" || echo "$(RED)‚ùå Reload failed.$(RESET)"

restart-clean: stop free-ports start

free-ports:
	@echo "$(YELLOW)üßπ Releasing ports 80 & 443...$(RESET)"
	@sudo lsof -ti :80 -sTCP:LISTEN | xargs -r sudo kill -9 || true
	@sudo lsof -ti :443 -sTCP:LISTEN | xargs -r sudo kill -9 || true
	@echo "$(GREEN)‚úÖ Ports released.$(RESET)"

# ==========================================================
# 6Ô∏è‚É£ SSL CONFIGURATION
# ==========================================================
enable-ssl:
	@echo "$(YELLOW)üîí Configuring SSL for $(DOMAIN)...$(RESET)"
	@sudo apt update -y && sudo apt install -y certbot python3-certbot-nginx
	@bash -c '\
	SSL_CONF="$(CONFIG_FILE)"; \
	if sudo certbot --nginx -d $(DOMAIN) -d www.$(DOMAIN) --non-interactive --agree-tos -m admin@$(DOMAIN); then \
		echo "$(GREEN)‚úÖ Certbot SSL installed.$(RESET)"; \
	else \
		echo "$(RED)‚ö†Ô∏è Certbot failed ‚Äî generating self-signed cert.$(RESET)"; \
		sudo mkdir -p /etc/nginx/ssl; \
		sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
			-keyout /etc/nginx/ssl/selfsigned.key \
			-out /etc/nginx/ssl/selfsigned.crt \
			-subj "/CN=$(DOMAIN)"; \
		sudo sed -i "s|ssl_certificate .*|ssl_certificate /etc/nginx/ssl/selfsigned.crt;|" $$SSL_CONF; \
		sudo sed -i "s|ssl_certificate_key .*|ssl_certificate_key /etc/nginx/ssl/selfsigned.key;|" $$SSL_CONF; \
	fi'
	@sudo nginx -t && sudo systemctl reload nginx

# ==========================================================
# 7Ô∏è‚É£ TEST SITE
# ==========================================================
test-site:
	@echo "$(YELLOW)üåç Checking site...$(RESET)"
	@curl -s --max-time 5 http://$(DOMAIN) | grep -qi "html" && echo "$(GREEN)‚úÖ HTTP OK$(RESET)" || echo "$(RED)‚ùå HTTP failed$(RESET)"
	@curl -s -k --max-time 5 https://$(DOMAIN) | grep -qi "html" && echo "$(GREEN)‚úÖ HTTPS OK$(RESET)" || echo "$(RED)‚ùå HTTPS failed$(RESET)"

# ==========================================================
# 8Ô∏è‚É£ ROLLBACK & CLEANUP
# ==========================================================
rollback-config:
	@echo "$(YELLOW)‚è™ Restoring default config...$(RESET)"
	@if [ -f "$(DEFAULT_CONF)" ]; then \
		sudo ln -sf $(DEFAULT_CONF) $(NGINX_ENABLED_DIR)/default; \
		sudo rm -f $(CONFIG_FILE); \
		sudo systemctl restart nginx || true; \
		echo "$(GREEN)‚úÖ Default restored.$(RESET)"; \
	else \
		echo "$(RED)‚ö†Ô∏è Default config missing.$(RESET)"; \
	fi

clean:
	@echo "$(YELLOW)üßπ Cleaning Nginx & SSL...$(RESET)"
	@sudo rm -f $(CONFIG_FILE) $(NGINX_ENABLED_DIR)/$(DOMAIN)
	@sudo rm -rf /var/cache/nginx/* /var/log/nginx/*
	@sudo rm -rf /etc/letsencrypt/live/$(DOMAIN) /etc/letsencrypt/archive/$(DOMAIN)
	@sudo rm -rf /etc/nginx/ssl/selfsigned.* || true
	@echo "$(GREEN)üéØ Cleanup complete.$(RESET)"
