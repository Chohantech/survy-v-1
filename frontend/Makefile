# ============================================================
# ğŸ”§ Next.js Paths & Environment Variables
# ============================================================
APP_DIR       := /var/www/svryn.com/frontend
APP_NAME      := svryn_app_client
NODE_ENV      := production
USER          := www-data
PORT          := 3000
HOSTNAME      := 0.0.0.0
DOMAIN        := https://www.svryn.com
SERVER_FILE   := $(APP_DIR)/.next/standalone/server.js

.PHONY: help build run setup start stop restart status logs startup test-site clean get-port

# ============================================================
# ğŸ“˜ help â€” Display all available Makefile commands
# ============================================================
help: ## Show this help message with available Makefile targets
	@echo ""
	@echo "ğŸ“˜ AVAILABLE COMMANDS"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@grep -E '^[a-zA-Z_-]+:.*?##' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "â–¶ %-20s %s\n", $$1, $$2}'
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo ""

# ============================================================
# ğŸ” get-port â€” Find first available free port
# ============================================================
get-port: ## Detect first free port starting from $(PORT)
	@PORT=$(PORT); \
	while lsof -i:$$PORT >/dev/null 2>&1; do \
		$$((PORT=PORT+1)); \
	done; \
	echo $$PORT > $(APP_DIR)/.port; \
	echo "ğŸ” Using free port $$PORT"

# ============================================================
# ğŸ—ï¸ build â€” Production Build (Next.js Standalone for Nginx)
# ============================================================
build: ## Build Next.js app in standalone mode for Nginx deployment
	@echo "ğŸ§¹ Removing previous Next.js build..."
	sudo chmod -R 777 $(APP_DIR) || true
	rm -rf $(APP_DIR)/.next

	@echo "ğŸ“¦ Installing dependencies..."
	cd $(APP_DIR) && npm install --legacy-peer-deps || { echo 'âŒ npm install failed!'; exit 1; }

	@echo "ğŸ—ï¸ Building Next.js (standalone mode)..."
	cd $(APP_DIR) && npm run build:web || { echo 'âŒ Build failed!'; exit 1; }

	@echo "ğŸ”§ Restoring secure permissions for Nginx..."
	sudo find $(APP_DIR) -type d -exec chmod 777 {} \;
	sudo find $(APP_DIR) -type f -exec chmod 777 {} \;
	sudo chown -R $(USER):$(USER) $(APP_DIR)


	@echo "âœ… Next.js build complete â€” ready for Nginx."

# ============================================================
# â–¶ run â€” Start Next.js Development Server
# ============================================================
run: ## Start Next.js development server
	@echo "ğŸš€ Starting Next.js development server..."
	cd $(APP_DIR) && npm run dev

# ============================================================
# 1ï¸âƒ£ setup â€” Install & Setup PM2
# ============================================================
setup: ## Install PM2 globally for process management
	@echo "âš™ï¸ Installing PM2 globally..."
	sudo npm install -g pm2
	@pm2 -v || { echo "âŒ PM2 installation failed!"; exit 1; }
	@echo "âœ… PM2 installed successfully."

# ============================================================
# 2ï¸âƒ£ start â€” Start Next.js Standalone App via PM2
# ============================================================
start: get-port ## Start the Next.js app using PM2
	@PORT=$$(cat $(APP_DIR)/.port); \
	echo "ğŸš€ Starting $(APP_NAME) via PM2 on $(HOSTNAME):$$PORT..."; \
	cd $(APP_DIR) && \
	sudo chmod -R 755 $(APP_DIR) && \
	sudo chmod -R 777 .next && \
	pm2 start node --name "$(APP_NAME)" -- \
		$(SERVER_FILE) \
		--env $(NODE_ENV) \
		HOSTNAME=$(HOSTNAME) \
		PORT=$$PORT
	@pm2 save
	@echo "âœ… App $(APP_NAME) started on $(HOSTNAME):$$PORT!"

# ============================================================
# 3ï¸âƒ£ stop & restart â€” Manage PM2 Processes
# ============================================================
stop: ## Stop the Next.js app managed by PM2
	@echo "ğŸ›‘ Stopping $(APP_NAME)..."
	@pm2 stop $(APP_NAME) || echo "âš ï¸ App not running."

restart: ## Restart the Next.js app via PM2
	@echo "ğŸ” Restarting $(APP_NAME)..."
	@pm2 restart $(APP_NAME) || $(MAKE) start
	@pm2 save
	@echo "âœ… Restarted successfully."

# ============================================================
# 4ï¸âƒ£ status & logs â€” PM2 Monitoring
# ============================================================
status: ## Show PM2 process list
	@echo "ğŸ“Š PM2 Process List"
	@pm2 list

logs: ## View logs for the Next.js app (Ctrl+C to exit)
	@echo "ğŸªµ Viewing logs for $(APP_NAME)..."
	@pm2 logs $(APP_NAME)

# ============================================================
# 5ï¸âƒ£ startup â€” Enable PM2 Auto-start on Server Boot
# ============================================================
startup: ## Enable PM2 to auto-start app on system boot
	@echo "ğŸ”„ Enabling PM2 startup service..."
	@sudo pm2 startup systemd -u $(USER) --hp /home/$(USER)
	@pm2 save
	@sudo systemctl enable pm2-$(USER)
	@sudo systemctl start pm2-$(USER)
	@echo "âœ… PM2 auto-start enabled."

# ============================================================
# 6ï¸âƒ£ test-site â€” Test Site Availability
# ============================================================
test-site: ## Test if site is responding with HTTP 200 OK
	@echo "ğŸŒ Testing site availability at $(DOMAIN)..."
	@if curl -s -o /dev/null -w "%{http_code}" $(DOMAIN) | grep -q "200"; then \
		echo "âœ… Site is UP and responding correctly."; \
	else \
		echo "âŒ Site is DOWN or not returning 200 OK."; \
	fi

# ============================================================
# 7ï¸âƒ£ clean â€” Remove PM2 Process
# ============================================================
clean: ## Remove the app from PM2 process list
	@echo "ğŸ§¹ Removing $(APP_NAME) from PM2..."
	@pm2 delete $(APP_NAME) || true
	@pm2 save
	@echo "âœ… PM2 process cleaned."
